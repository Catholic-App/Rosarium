<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendário de Terços - Rosarium</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <button class="btn-back" onclick="goBack()">← Voltar</button>
      <div class="header-title">
        <div class="header-logo">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <span>Calendário de Terços</span>
      </div>
    </div>
  </header>

  <!-- Conteúdo -->
  <div class="page-container">
    <div class="page-content container-md">
      <h1 class="page-title">Histórico de Terços Rezados</h1>

      <!-- Calendário -->
      <div class="calendar">
        <div class="calendar-header">
          <h3 class="calendar-title" id="calendar-title"></h3>
          <div class="calendar-nav">
            <button onclick="previousMonth()">← Anterior</button>
            <button onclick="nextMonth()">Próximo →</button>
          </div>
        </div>

        <!-- Grid -->
        <div class="calendar-grid" id="calendar-grid"></div>
      </div>

      <!-- Estatísticas -->
      <div class="card" style="margin-top: 2rem;">
        <h3 class="card-title">Estatísticas do Mês</h3>
        <div class="card-content">
          <p><strong>Total de terços rezados:</strong> <span id="total-tercos">0</span></p>
          <p><strong>Dias com terço:</strong> <span id="days-with-terco">0</span></p>
          <p><strong>Sequência atual:</strong> <span id="current-streak">0</span> dias</p>
        </div>
      </div>

      <!-- Histórico -->
      <div class="card" style="margin-top: 2rem;">
        <h3 class="card-title">Últimos Terços Rezados</h3>
        <div class="items-list" id="history-list"></div>
      </div>
    </div>
  </div>

  <script src="app.js"></script>

  <script>

    let currentDate = new Date();

    function renderCalendar() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();

      // título
      document.getElementById("calendar-title").textContent =
        `${App.Calendar.getMonthName(month)} ${year}`;

      const grid = document.getElementById("calendar-grid");
      grid.innerHTML = "";

      // cabeçalho semana
      ["Dom","Seg","Ter","Qua","Qui","Sex","Sab"].forEach(d => {
        const el = document.createElement("div");
        el.className = "calendar-day-header";
        el.textContent = d;
        grid.appendChild(el);
      });

      // preenchimento antes do dia 1
      const firstDay = new Date(year, month, 1).getDay();
      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement("div");
        empty.className = "calendar-day other-month";
        grid.appendChild(empty);
      }

      const daysInMonth = App.Calendar.getDaysInMonth(year, month);
      const all = App.Calendar.getAll();
      const today = new Date();

      for (let d = 1; d <= daysInMonth; d++) {
        const el = document.createElement("div");
        el.className = "calendar-day";
        el.textContent = d;

        if (
          d === today.getDate() &&
          month === today.getMonth() &&
          year === today.getFullYear()
        ) el.classList.add("today");

        const dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;

        if (all[dateStr]) el.classList.add("marked");

        grid.appendChild(el);
      }

      updateStats();
    }

    function updateStats() {
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      const all = App.Calendar.getAll();

      let total = 0;
      let days = 0;

      for (const date in all) {
        const [y,m] = date.split("-");
        if (+y === year && +m === month+1) {
          total += all[date].length;
          days++;
        }
      }

      document.getElementById("total-tercos").textContent = total;
      document.getElementById("days-with-terco").textContent = days;

      // streak
      let streak = 0;
      let check = new Date();
      while (true) {
        const ds = check.toISOString().split("T")[0];
        if (all[ds]) {
          streak++;
          check.setDate(check.getDate() - 1);
        } else break;
      }
      document.getElementById("current-streak").textContent = streak;

      updateHistory();
    }

    function updateHistory() {
      const history = document.getElementById("history-list");
      history.innerHTML = "";

      const all = App.Calendar.getAll();
      const dates = Object.keys(all).sort().reverse().slice(0,10);

      if (!dates.length) {
        history.innerHTML = `<p style="text-align:center;padding:1rem;color:var(--muted-foreground)">Nenhum terço rezado</p>`;
        return;
      }

      for (const date of dates) {
        const items = all[date];
        const readable = items
          .map(i =>
            i.tipo === "mariano" ? "Terço Mariano" :
            i.tipo === "misericordia" ? "Terço da Misericórdia" :
            i.tipo === "rosario" ? "Rosário" :
            i.tipo
          ).join(", ");

        const card = document.createElement("div");
        card.className = "item";
        card.innerHTML = `
          <div class="item-content">
            <div class="item-title">
              ${new Date(date).toLocaleDateString('pt-BR',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
            </div>
            <div class="item-description">${readable}</div>
          </div>
        `;
        history.appendChild(card);
      }
    }

    function previousMonth() {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth() {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }

    document.addEventListener("DOMContentLoaded", renderCalendar);

  </script>

</body>
</html>
