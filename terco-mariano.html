<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Terço Mariano - Rosarium</title>
  <link rel="stylesheet" href="style.css">
  <style>
    :root{
      --primary: #4360C6;
      --bg: #FCFAFB;
      --text: #121212;
      --muted: #666;
      --icon: #4D3E43;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial}
    .header{display:flex;align-items:center;padding:12px 16px;gap:.6rem}
    .btn-back{background:transparent;border:none;cursor:pointer;color:var(--text);font-size:1rem}
    .header-title{display:flex;align-items:center;gap:.6rem;font-weight:700}
    .page-container{max-width:760px;margin:1.25rem auto;padding:0 16px}
    .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.04);margin-bottom:12px}
    .prayer-card{padding:14px}
    .prayer-card h3{margin:0 0 6px 0}
    .prayer-card p{margin:0;line-height:1.6}
    .prayer-meta{color:var(--muted);margin-top:8px;font-size:.95rem}
    .misterio-box{background:#eef6ff;border-left:4px solid var(--primary);padding:10px;border-radius:8px;margin-bottom:12px;display:none}
    .misterio-box strong{display:block;margin-bottom:.25rem}
    .counter{ text-align:center; padding:12px }
    .counter-display{ font-weight:700; font-size:1.4rem }
    .small-muted{ color:var(--muted); font-size:.95rem }
    .beads-container{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
    .bead{ display:inline-flex; align-items:center; justify-content:center; user-select:none; cursor:pointer; background:#fbfbfb; color:var(--icon); box-shadow:0 1px 3px rgba(0,0,0,0.04); }
    .bead.am{ width:34px; height:34px; border-radius:50%; font-weight:600 }       /* Ave Maria - menor */
    .bead.pn{ width:44px; height:44px; border-radius:50%; font-weight:700 }       /* Pai-Nosso - maior */
    .bead.filled{ background:var(--primary); color:#fff; box-shadow:0 6px 14px rgba(67,96,198,0.18) }
    .cross{ width:44px; height:44px; display:inline-flex;align-items:center;justify-content:center;border-radius:6px;background:#fff;color:var(--icon); box-shadow:0 1px 3px rgba(0,0,0,0.04); font-weight:700; cursor:pointer }
    .cross.filled{ background:var(--primary); color:#fff; }
    .progress-bar{height:8px;background:#eee;border-radius:999px;overflow:hidden;margin:8px 18px}
    .progress-fill{height:100%;width:0;background:var(--primary);transition:width .25s ease}
    .buttons{display:flex;gap:.6rem;justify-content:center;margin-top:8px;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:none;background:var(--primary);color:#fff;cursor:pointer;font-weight:700}
    .btn-outline{background:transparent;border:1px solid #ddd;color:var(--text)}
    @media (max-width:420px){ .bead.am{width:30px;height:30px} .bead.pn{width:38px;height:38px} .cross{width:38px;height:38px} .counter-display{font-size:1.15rem} }
  </style>
</head>
<body>
  <header class="header">
    <button class="btn-back" onclick="history.back()">← Voltar</button>
    <div class="header-title" aria-hidden="false">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>Terço Mariano</span>
    </div>
  </header>

  <main class="page-container">
    <!-- Oração atual (card grande) -->
    <div class="card prayer-card" id="prayerCard" role="region" aria-live="polite">
      <h3 id="prayerTitle">Oração atual</h3>
      <p id="prayerText">Carregando...</p>
      <div class="prayer-meta" id="prayerMeta"></div>
    </div>

    <!-- Mistério (aparece só quando for PN que inicia a dezena) -->
    <div id="misterioBox" class="misterio-box" aria-hidden="true">
      <strong id="misterioTitle"></strong>
      <div id="misterioText"></div>
    </div>

    <!-- Contador / Bolinhas -->
    <div class="card counter" role="group" aria-labelledby="tercoStatus">
      <div id="counterDisplay" class="counter-display">0 / 0</div>
      <div class="small-muted" id="tercoStatus">Progresso do Terço Mariano</div>

      <!-- Cruz do Credo (ícone) -->
      <div style="display:flex;justify-content:center;gap:8px;margin:12px 0">
        <div id="credoCross" class="cross" title="Creio" role="button" aria-label="Ir para o Credo">✝</div>
      </div>

      <div id="beadsContainer" class="beads-container" aria-hidden="false"></div>

      <div class="progress-bar" aria-hidden="false">
        <div id="progressFill" class="progress-fill" style="width:0%"></div>
      </div>
      <div id="progressLabel" class="small-muted" style="margin-top:6px">0%</div>

      <div class="buttons">
        <button class="btn" id="btnNext" aria-label="Próxima oração">+ Próxima</button>
        <button class="btn btn-outline" id="btnReset" aria-label="Resetar o terço">Resetar</button>
      </div>
    </div>
  </main>

  <script>
  /* ===========================
     Terço Mariano — versão completa (53 Ave-Marias)
     Requisitos aplicados:
     - Credo mostrado como cruz (não é bead)
     - Beads somente para Pai-Nosso (pn) e Ave-Maria (am)
     - Pai-Nosso (pn) com bead maior; Ave-Maria (am) bead menor
     - Mistério aparece apenas no Pai-Nosso que inicia cada dezena (pn cujo passo anterior é 'gl')
     - Pai-Nosso inicial (abertura) NÃO mostra mistério
     - Glória não tem bead; ao entrar em glória não preenche novas beads
     - Salve Rainha ao final
     - Jump via beads e cruz
     - Salvamento em localStorage
     ===========================*/

  const ORACOES = {
    sinal_da_cruz: "Em nome do Pai, do Filho e do Espírito Santo. Amém.",
    credo: "Creio em Deus Pai todo-poderoso, criador do céu e da terra; e em Jesus Cristo, seu único Filho, nosso Senhor, que foi concebido pelo poder do Espírito Santo, nasceu da Virgem Maria, padeceu sob Pôncio Pilatos, foi crucificado, morto e sepultado; desceu à mansão dos mortos; ressuscitou ao terceiro dia; subiu aos céus; e está sentado à direita de Deus Pai todo-poderoso; donde há de vir a julgar os vivos e os mortos. Creio no Espírito Santo, na santa Igreja Católica, na comunhão dos santos, na remissão dos pecados, na ressurreição da carne e na vida eterna. Amém.",
    pai_nosso: "Pai nosso, que estais nos céus, santificado seja o vosso nome; venha a nós o vosso reino; seja feita a vossa vontade, assim na terra como no céu. O pão nosso de cada dia nos dai hoje; perdoai-nos as nossas dívidas, assim como nós perdoamos aos nossos devedores; e não nos deixeis cair em tentação; mas livrai-nos do mal. Amém.",
    ave_maria: "Ave Maria, cheia de graça, o Senhor é convosco; bendita sois vós entre as mulheres, e bendito é o fruto do vosso ventre, Jesus. Santa Maria, Mãe de Deus, rogai por nós, pecadores, agora e na hora da nossa morte. Amém.",
    gloria: "Glória ao Pai, e ao Filho, e ao Espírito Santo. Como era no princípio, agora e sempre. Amém.",
    salve_rainha: "Salve Rainha, Mãe de Misericórdia, vida, doçura e esperança nossa, salve. A vós bradamos, os degredados filhos de Eva. A vós suspiramos, gemendo e chorando neste vale de lágrimas. Eia, pois, advogada nossa, esses vossos olhos misericordiosos voltai a nós; e depois deste desterro mostrai-nos Jesus, bendito fruto do vosso ventre. Ó clemente, ó piedosa, ó doce sempre Virgem Maria. Rogai por nós, santa Mãe de Deus. Para que sejamos dignos das promessas de Cristo. Amém."
  };

  const MISTERIOS = {
    gozosos: [
      "1º Mistério Gozoso — A Anunciação: O Anjo anuncia a Maria que será Mãe de Deus.",
      "2º Mistério Gozoso — A Visitação: Maria visita Isabel.",
      "3º Mistério Gozoso — O Nascimento: Jesus nasce em Belém.",
      "4º Mistério Gozoso — A Apresentação: Jesus é apresentado no Templo.",
      "5º Mistério Gozoso — O Encontro no Templo."
    ],
    luminosos: [
      "1º Mistério Luminoso — O Batismo no Jordão.",
      "2º Mistério Luminoso — As Bodas de Caná.",
      "3º Mistério Luminoso — O Anúncio do Reino.",
      "4º Mistério Luminoso — A Transfiguração.",
      "5º Mistério Luminoso — A Instituição da Eucaristia."
    ],
    dolorosos: [
      "1º Mistério Doloroso — A Agonia no Horto.",
      "2º Mistério Doloroso — A Flagelação.",
      "3º Mistério Doloroso — A Coroação de Espinhos.",
      "4º Mistério Doloroso — O Caminho do Calvário.",
      "5º Mistério Doloroso — A Crucifixão."
    ],
    gloriosos: [
      "1º Mistério Glorioso — A Ressurreição.",
      "2º Mistério Glorioso — A Ascensão.",
      "3º Mistério Glorioso — Pentecostes.",
      "4º Mistério Glorioso — A Assunção de Maria.",
      "5º Mistério Glorioso — A Coroação de Maria."
    ]
  };

  // monta sequência oficial:
  // sinal (opcional, sem bead), credo (cruz), PN inicial, 3 AM iniciais, GL
  // depois 5 dezenas: PN + 10 AM + GL
  // final: Salve Rainha
  const SEQUENCE = (function(){
    const s = [];
    s.push('sinal');                   // 0
    s.push('credo');                   // 1 (cross)
    s.push('pn');                      // 2 initial PN (bead)
    s.push('am','am','am');            // 3,4,5 (3 AM) (beads)
    s.push('gl');                      // 6 (glória)
    for(let d=0; d<5; d++){
      s.push('pn');                    // PN of decade (bead)
      for(let i=0;i<10;i++) s.push('am'); // 10 AM per decade (beads)
      s.push('gl');                    // gloria (no bead)
    }
    s.push('salve');                   // final
    return s;
  })();

  // localStorage key
  const STORAGE_KEY = 'rosarium_terco_mariano_v4';

  // state: just stepIndex is enough; counts computed on the fly
  let state = { stepIndex: 0 };

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) state = JSON.parse(raw);
    }catch(e){ console.warn('loadState err', e); }
  }
  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){ console.warn('saveState err', e); }
  }

  // get mystery set for today
  function getMisterioInfo(){
    const d = new Date().getDay();
    if (d === 1 || d === 6) return { key: 'gozosos', label: 'Mistérios Gozosos' }; // seg/sáb
    if (d === 2 || d === 5) return { key: 'dolorosos', label: 'Mistérios Dolorosos' }; // ter/sex
    if (d === 4) return { key: 'luminosos', label: 'Mistérios Luminosos' }; // quinta
    return { key: 'gloriosos', label: 'Mistérios Gloriosos' }; // dom/qua
  }

  // compute how many AM have occurred up to a given stepIndex
  function countAMUpTo(stepIndex){
    let c = 0;
    for(let i=0;i<=stepIndex;i++) if(SEQUENCE[i] === 'am') c++;
    return c;
  }

  // compute beadSteps: array of { stepIndex, type } for all pn/am in sequence
  function buildBeadSteps(){
    const arr = [];
    for(let i=0;i<SEQUENCE.length;i++){
      if(SEQUENCE[i] === 'pn' || SEQUENCE[i] === 'am') arr.push({ stepIndex: i, type: SEQUENCE[i] });
    }
    return arr;
  }

  // determine index of decade-mystery for a given stepIndex:
  // count how many pn that start decades (pn whose previous step is 'gl') exist up to this stepIndex,
  // then index = count - 1 (0-based). If none, return -1.
  function computeMysteryIndexForStep(stepIndex){
    let count = 0;
    for(let i=0;i<=stepIndex;i++){
      if(SEQUENCE[i] === 'pn' && SEQUENCE[i-1] === 'gl') count++;
    }
    return count - 1; // -1 when no decade pn encountered yet
  }

  function render(){
    const step = SEQUENCE[state.stepIndex];
    const prayerTitleEl = document.getElementById('prayerTitle');
    const prayerTextEl  = document.getElementById('prayerText');
    const prayerMetaEl  = document.getElementById('prayerMeta');
    const misterioBox    = document.getElementById('misterioBox');
    const misterioTitle  = document.getElementById('misterioTitle');
    const misterioText   = document.getElementById('misterioText');

    // hide misterio by default
    misterioBox.style.display = 'none';
    misterioTitle.innerText = '';
    misterioText.innerText = '';

    // set prayer text
    if(step === 'sinal'){
      prayerTitleEl.innerText = 'Sinal da Cruz';
      prayerTextEl.innerText = ORACOES.sinal_da_cruz;
      prayerMetaEl.innerText = '';
    } else if(step === 'credo'){
      prayerTitleEl.innerText = 'Creio';
      prayerTextEl.innerText = ORACOES.credo;
      prayerMetaEl.innerText = '';
    } else if(step === 'pn'){
      prayerTitleEl.innerText = 'Pai-Nosso';
      prayerTextEl.innerText = ORACOES.pai_nosso;
      // only show mystery if this PN starts a decade (previous step was 'gl')
      const isDezenaPN = SEQUENCE[state.stepIndex - 1] === 'gl';
      if(isDezenaPN){
        const info = getMisterioInfo();
        const mIndex = computeMysteryIndexForStep(state.stepIndex); // 0-based
        if(mIndex >= 0 && mIndex < 5){
          misterioBox.style.display = 'block';
          misterioTitle.innerText = `${info.label} — ${mIndex + 1}º`;
          misterioText.innerText = MISTERIOS[info.key][mIndex];
        }
        prayerMetaEl.innerText = `Pai-Nosso da dezena ${computeMysteryIndexForStep(state.stepIndex) + 1}`;
      } else {
        // PN initial (or other PN not starting a decade)
        prayerMetaEl.innerText = '';
      }
    } else if(step === 'am'){
      prayerTitleEl.innerText = 'Ave-Maria';
      prayerTextEl.innerText = ORACOES.ave_maria;
      const amSoFar = countAMUpTo(state.stepIndex);
      prayerMetaEl.innerText = `Ave-Maria ${amSoFar} de 53`;
    } else if(step === 'gl'){
      prayerTitleEl.innerText = 'Glória ao Pai';
      prayerTextEl.innerText = ORACOES.gloria;
      prayerMetaEl.innerText = '';
    } else if(step === 'salve'){
      prayerTitleEl.innerText = 'Salve Rainha';
      prayerTextEl.innerText = ORACOES.salve_rainha;
      prayerMetaEl.innerText = '';
    } else {
      prayerTitleEl.innerText = '';
      prayerTextEl.innerText = '';
      prayerMetaEl.innerText = '';
    }

    // update counter display
    document.getElementById('counterDisplay').innerText = `${state.stepIndex + 1} / ${SEQUENCE.length}`;

    // render beads
    const beadsContainer = document.getElementById('beadsContainer');
    beadsContainer.innerHTML = '';
    const beadSteps = buildBeadSteps();

    // compute lastFilledGlobal: greatest global step index (in SEQUENCE) <= state.stepIndex that is 'pn' or 'am'
    let lastFilledGlobal = -1;
    for(let j=0;j<=state.stepIndex;j++){
      if(SEQUENCE[j] === 'pn' || SEQUENCE[j] === 'am') lastFilledGlobal = j;
    }
    // note: when state.stepIndex is a 'gl' step, lastFilledGlobal will be the last pn/am before that gl,
    // so moving to gl doesn't mark any new bead (as required).

    beadSteps.forEach((b, idx) => {
      const div = document.createElement('div');
      div.className = 'bead ' + (b.type === 'pn' ? 'pn' : 'am');
      if(b.stepIndex <= lastFilledGlobal) div.classList.add('filled');
      // label: for pn show 'P', for am show localized number within the AM sequence for readability (optional)
      if(b.type === 'pn') div.textContent = 'P';
      else {
        // compute how many AM beads came before this bead to show a small ordinal when helpful
        // but to keep UI compact, show a sequential number relative to AM beads
        let amIndex = 0;
        for(let k=0;k<beadSteps.length;k++){
          if(beadSteps[k].type === 'am'){
            if(k === idx) break;
            amIndex++;
          }
        }
        div.textContent = ''; // keep blank for cleaner look; icon shape suffices
      }
      div.title = `${b.type === 'pn' ? 'Pai-Nosso' : 'Ave-Maria'} — passo ${b.stepIndex + 1}`;
      div.onclick = () => jumpTo(b.stepIndex);
      beadsContainer.appendChild(div);
    });

    // progress percent by global steps
    const pct = Math.round(((state.stepIndex + 1) / SEQUENCE.length) * 100);
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressLabel').innerText = pct + '%';

    // mark creed cross as filled when stepIndex > indexOf('credo')
    const creedIdx = SEQUENCE.indexOf('credo');
    const crossEl = document.getElementById('credoCross');
    if(state.stepIndex > creedIdx) crossEl.classList.add('filled'); else crossEl.classList.remove('filled');

    // accessibility: set misterioBox aria-hidden
    misterioBox.setAttribute('aria-hidden', misterioBox.style.display === 'none' ? 'true' : 'false');
  }

  // move to next step (user pressed Next)
  function nextStep(){
    if(state.stepIndex >= SEQUENCE.length - 1){
      // Marcar terço como completo no calendário
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      const calendar = Terco.getTercoCalendar();
      
      if (!calendar[dateStr]) {
        calendar[dateStr] = [];
      }
      
      if (!calendar[dateStr].includes('mariano')) {
        calendar[dateStr].push('mariano');
        Storage.set('terco_calendar', calendar);
        console.log('Terço Mariano registrado para:', dateStr);
      }
      
      alert('Terço completo — Glória a Deus!');
      
      // Resetar para próximo terço
      setTimeout(() => {
        state = { stepIndex: 0 };
        saveState();
        render();
      }, 1500);
      
      return;
    }
    state.stepIndex++;
    // For pn/am counters we compute on the fly in render()
    saveState();
    render();
  }

  // reset
  function resetTerco(){
    if(!confirm('Deseja resetar o Terço Mariano?')) return;
    state = { stepIndex: 0 };
    saveState();
    render();
  }

  // jump to a global step (used by beads and cross)
  function jumpTo(globalStepIndex){
    if(typeof globalStepIndex !== 'number') return;
    if(globalStepIndex < 0 || globalStepIndex >= SEQUENCE.length) return;
    state.stepIndex = globalStepIndex;
    saveState();
    render();
  }

  // wire events
  document.addEventListener('DOMContentLoaded', () => {
    loadState();
    // normalize
    if(typeof state.stepIndex !== 'number' || state.stepIndex < 0 || state.stepIndex >= SEQUENCE.length) state.stepIndex = 0;
    render();
    document.getElementById('btnNext').addEventListener('click', nextStep);
    document.getElementById('btnReset').addEventListener('click', resetTerco);
    document.getElementById('credoCross').addEventListener('click', () => {
      const idx = SEQUENCE.indexOf('credo');
      if(idx >= 0) jumpTo(idx);
    });
  });
  </script>
</body>
</html>